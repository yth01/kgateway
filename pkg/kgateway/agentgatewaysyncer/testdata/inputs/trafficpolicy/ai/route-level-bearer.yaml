apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: example-gateway
  namespace: default
spec:
  gatewayClassName: agentgateway
  listeners:
  - allowedRoutes:
      namespaces:
        from: Same
    name: http
    port: 8080
    protocol: HTTP
---
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  labels:
    app: kgateway
  name: openai
spec:
  ai:
    provider:
      openai:
        model: "gpt-4o-mini"
---
apiVersion: v1
kind: Secret
metadata:
  name: openai-secret
type: Opaque
data:
  Authorization: QmVhcmVyIG15c2VjcmV0a2V5
---
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayPolicy
metadata:
  name: ai-policy
  namespace: default
spec:
  backend:
    ai:
      prompt:
        prepend:
        - content: "You are a helpful assistant. Always be polite and professional."
          role: system
        - content: "Remember to follow company guidelines."
          role: system
        append:
        - content: "Please provide a concise response."
          role: user
      promptGuard:
        request:
        - response:
            message: "Your request was rejected due to inappropriate content"
            statusCode: 403
          webhook:
            backendRef:
              name: "webhook"
              port: 8443
            forwardHeaderMatches:
            - type: Exact
              name: x-foo
              value: bar
            - type: RegularExpression
              name: x-baz
              value: ^baz-.*
        - regex:
            action: REJECT
            matches:
            - (?i)(hate|kill|harm)
            - (?i)(bad|words)
            builtins:
              - CREDIT_CARD
              - SSN
        - openAIModeration:
            model: text-moderation-latest
            policies:
              auth:
                secretRef:
                  name: openai-secret
        response:
        - webhook:
            backendRef:
              name: "webhook"
              port: 8443
        - regex:
            action: MASK
            builtins:
            - EMAIL
            - PHONE_NUMBER
            matches:
            - \b\d{4}\b
            - (?i)(password|secret)
  targetRefs:
  - group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: openai-test
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: openai-test
  namespace: default
spec:
  parentRefs:
  - group: gateway.networking.k8s.io
    kind: Gateway
    name: example-gateway
  rules:
  - backendRefs:
    - group: agentgateway.dev
      kind: AgentgatewayBackend
      name: openai
      weight: 1
    matches:
    - path:
        type: PathPrefix
        value: /v1/chat/completions
---
apiVersion: v1
kind: Service
metadata:
  name: webhook
  namespace: default
spec:
  ports:
    - port: 80