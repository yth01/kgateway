apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: example-gateway
spec:
  gatewayClassName: agentgateway
  listeners:
    - name: http
      protocol: HTTP
      port: 80
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: example-route
spec:
  parentRefs:
    - name: example-gateway
  hostnames:
    - "example.com"
  rules:
    - backendRefs:
        - group: agentgateway.dev
          kind: AgentgatewayBackend
          name: mcp-backend-static
      rule:
        matches:
        - path:
            type: Prefix
            value: /static
    - backendRefs:
        - group: agentgateway.dev
          kind: AgentgatewayBackend
          name: mcp-backend-selector
      rule:
        matches:
        - path:
            type: Prefix
            value: /selector
---
apiVersion: v1
kind: Service
metadata:
  name: example-svc
  labels:
    app: mcp-app
spec:
  selector:
    test: test
  ports:
    - protocol: TCP
      appProtocol: kgateway.dev/mcp
      port: 80
      targetPort: test
    - protocol: TCP
      appProtocol: kgateway.dev/mcp-sse
      port: 90
      targetPort: test-2
---
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: mcp-backend-selector
spec:
  mcp:
    targets:
      - name: mcp-app
        selector:
          services:
            matchLabels:
              app: mcp-app
---
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: mcp-backend-static
spec:
  mcp:
    targets:
      - name: mcp-target
        static:
          host: mcp-app.default.svc.cluster.local
          port: 8000
          protocol: StreamableHTTP
          path: override-sse
---
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayPolicy
metadata:
  name: keycloak-mcp-authn-policy
spec:
  targetRefs:
    - name: mcp-backend-static
      kind: Backend
      group: gateway.kgateway.dev
    - name: mcp-backend-selector
      kind: Backend
      group: gateway.kgateway.dev
  backend:
    mcp:
      authentication:
        issuer: http://keycloak:7080/realms/mcp
        jwks:
          jwksPath: realms/mcp/protocol/openid-connect/certs
          backendRef:
            group: ""
            kind: Service
            name: keycloak
            port: 7080
        audiences:
          - "account"
        provider: Keycloak
        resourceMetadata:
          resource: http://mcp-website-fetcher.default.svc.cluster.local/mcp
          scopesSupported: '["tools/call/fetch"]'
          bearerMethodsSupported: '["header"]'
          resourceDocumentation: http://mcp-website-fetcher.default.svc.cluster.local/docs
          resourcePolicyUri: http://mcp-website-fetcher.default.svc.cluster.local/policies
---
apiVersion: v1
data:
  jwks-store: '{"http://keycloak.default.svc.cluster.local:7080/realms/mcp/protocol/openid-connect/certs":"{\"keys\":[{\"use\":\"enc\",\"kty\":\"RSA\",\"kid\":\"-VsQtem_T9-RdhVcv9hK3qVGqtrpLil5z1-ivX2StZY\",\"alg\":\"RSA-OAEP\",\"n\":\"klR5MxpPeHVd8cCtYvEL-9lcsv8gTaR_4MM053_XIhzJtq8kV3TY8Co35LD926QzCNam0qhZzckGn0W3S9hPkomNtXsbEoe5-kqY5BpfolUMj9ZfACz04QRqQIdecUGoHh4hAV07-UqHVUEwCVQNjVGZMzHnS05xxeVdCJPc-1KJrw_AVV6tKKSq0Q6TUWs6BFsXCd5zXQEyYPOmSflAmB7-xogWgdBoSplOkiiiGXeJu2_lW4Ob4C5n-cYDjo5-LB6YU3JLBqv78Srs-_wFrtIgG6-LoiljY_hMUWjzBIoHeFILrq02JDboQTJLcyAofRtC04zpFa4ysoSBZqo_6Q\",\"e\":\"AQAB\",\"x5c\":[\"MIIClTCCAX0CBgGaooxVrjANBgkqhkiG9w0BAQsFADAOMQwwCgYDVQQDDANtY3AwHhcNMjUxMTIwMTgzMzE3WhcNMzUxMTIwMTgzNDU3WjAOMQwwCgYDVQQDDANtY3AwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCSVHkzGk94dV3xwK1i8Qv72Vyy/yBNpH/gwzTnf9ciHMm2ryRXdNjwKjfksP3bpDMI1qbSqFnNyQafRbdL2E+SiY21exsSh7n6SpjkGl+iVQyP1l8ALPThBGpAh15xQageHiEBXTv5SodVQTAJVA2NUZkzMedLTnHF5V0Ik9z7UomvD8BVXq0opKrRDpNRazoEWxcJ3nNdATJg86ZJ+UCYHv7GiBaB0GhKmU6SKKIZd4m7b+Vbg5vgLmf5xgOOjn4sHphTcksGq/vxKuz7/AWu0iAbr4uiKWNj+ExRaPMEigd4UguurTYkNuhBMktzICh9G0LTjOkVrjKyhIFmqj/pAgMBAAEwDQYJKoZIhvcNAQELBQADggEBAA6+I0exuvYlEp+wMgBVAliQiETEWijdLokyM/q0CxKPzM81noK/IOdP0+V5vju2hscfgnWO+RN4sIadFs1aplKnQHWeh5AUK3GH1xurTHKE55yOaC3kk855HNrDTGeKtbDwd/map7LRa4X3ZXc4plBkL3cRIRtZg5nautiWt94IsnsXQ2lBEYO68bmjPXXpjTCaVVju5jFAdc+Vv6KaCNGomLfKZnIMk96vRxcy+hR2apyYuzb9b6dUIGqGW7vguyM/3dBKNwYlfCPOINEUsoHeaXM18AQ9gNkxGrC7yxlu4Tt7i+b40VGIgNb1hMYw4U4L2lHbQYgGnqEXGEuk+iE=\"],\"x5t\":\"1bM36pjoqy7SvlCrwSBe5WKCnIg\",\"x5t#S256\":\"8lZWfHlpSiOGQeBhWD15fcX2Z1Ti3GwFDtC0yhO62iA\"},{\"use\":\"sig\",\"kty\":\"RSA\",\"kid\":\"iGhgcK6D5_FtqvMxquHUBk1R8vo_fBMPQWO7SGKvu4s\",\"alg\":\"RS256\",\"n\":\"wFxBVOqXcBkMCMex9W5bLB-vQA_47yGaOgaFtomNUFAvUl5YvCeuYbKsPfAsgTY0r_IGqsJm6T5MPdDPNpXrg2iC0v8TqbXxAUJHJdxOeK_md4HkVKa7yA5z6mEC2kEP3YyPeeCcV4F8l_tH9KEP3uZ957N0i9hTWgvOKbDI5TBGWsndu29p9ukqfY4vR1_TLp2W-uOWs6xeEylYQymfvRw14DFOyQ1EqrLxh9j4h6I58xKd0QuQypAbsRVosEaDy6rIyMOtcWdib4Urc9IEok_ZNIEuWvdROzWpSBALxudKNw0dAWkb0EP-T260zF0PjwVe9jAnvc5E7TtSTtUSNQ\",\"e\":\"AQAB\",\"x5c\":[\"MIIClTCCAX0CBgGaooxUwzANBgkqhkiG9w0BAQsFADAOMQwwCgYDVQQDDANtY3AwHhcNMjUxMTIwMTgzMzE3WhcNMzUxMTIwMTgzNDU3WjAOMQwwCgYDVQQDDANtY3AwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDAXEFU6pdwGQwIx7H1blssH69AD/jvIZo6BoW2iY1QUC9SXli8J65hsqw98CyBNjSv8gaqwmbpPkw90M82leuDaILS/xOptfEBQkcl3E54r+Z3geRUprvIDnPqYQLaQQ/djI954JxXgXyX+0f0oQ/e5n3ns3SL2FNaC84psMjlMEZayd27b2n26Sp9ji9HX9MunZb645azrF4TKVhDKZ+9HDXgMU7JDUSqsvGH2PiHojnzEp3RC5DKkBuxFWiwRoPLqsjIw61xZ2JvhStz0gSiT9k0gS5a91E7NalIEAvG50o3DR0BaRvQQ/5PbrTMXQ+PBV72MCe9zkTtO1JO1RI1AgMBAAEwDQYJKoZIhvcNAQELBQADggEBAFz7bs/LvuExjgijQ1awszjURHwVOPiplfFzvD3IETNDQsTh0krlFFze2FmPAyjIFwfuahoJ3Y0TskhCJTscwPgI2CHHMsL/N2qnHImlIVDWS8kqjJ5Y4tFcnvALE/Q9mNQ55sNkj4/4UZGeOAmnIz6JrWg6MWUGmawc1iGZpk/80dSUoI882gXCDNrNIfL1Fq5SbqRC/DCnGJXD6FsgQAUnnEVlJiLdcOGlpNC9VeuAI72Xwm3wXbIlp8261vgzZdXTNf1x6P+55wZtbLFozkfShqKHPHb3d01sYE8k54tdbC5U3S7kaA17LIhMTJF8rtgBLPBvpsPXqdxrIhv+40s=\"],\"x5t\":\"zleSIM51HMsnq9hHk3cYB4W8Hbs\",\"x5t#S256\":\"aiG5FvGkx3gyaRONjzYNS_MCpXWqxRFQsBeWW_54UMs\"}]}"}'
kind: ConfigMap
metadata:
  labels:
    app.kubernetes.io/component: jwks-store
  name: jwks-store-1ede70d6c818eff6121a0625c628681a
  namespace: kgateway-system
