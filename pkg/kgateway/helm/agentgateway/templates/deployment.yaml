{{- $gateway := .Values.agentgateway }}
{{- $promAnnotations := (dict
  "prometheus.io/path" "/metrics"
  "prometheus.io/port" "15020"
  "prometheus.io/scrape" "true")
}}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "kgateway.gateway.fullname" . }}
  {{- with $gateway.gatewayAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  labels:
    {{- include "kgateway.gateway.allLabels" . | nindent 4 }}
spec:
  selector:
    matchLabels:
      {{- include "kgateway.gateway.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      annotations:
      {{- /* Add configmap checksum to trigger rollout when config changes */}}
      {{- $configChecksum := dict "checksum/config" (include (print $.Template.BasePath "/configmap.yaml") . | sha256sum) }}
      {{- toYaml (merge
          $configChecksum
          (deepCopy ($gateway.gatewayAnnotations | default dict))
          $promAnnotations
          (include "kgateway.gateway.gatewayNameAnnotation" . | fromYaml)
       ) | nindent 8 }}
      labels:
        {{- toYaml (merge
          (dict "gateway.networking.k8s.io/gateway-class-name" .Values.agentgateway.gatewayClassName)
          (include "kgateway.gateway.selectorLabels" . | fromYaml)
          ($gateway.gatewayLabels | default dict)
          ((hasKey $gateway "istio") | ternary (dict "istio.io/dataplane-mode" "none" "sidecar.istio.io/inject" "false") (dict))
        ) | nindent 8 }}
    spec:
      serviceAccountName: {{ include "kgateway.gateway.fullname" . }}
      securityContext:
        sysctls:
          - name: net.ipv4.ip_unprivileged_port_start
            value: "0"
      containers:
        - name: agentgateway
          image: "{{ template "kgateway.gateway.image" $gateway.image }}"
          {{- if $gateway.image.pullPolicy }}
          imagePullPolicy: {{ $gateway.image.pullPolicy | quote }}
          {{- end }}
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 10101
          readinessProbe:
            httpGet:
              path: /healthz/ready
              port: 15021
            periodSeconds: 10
          startupProbe:
            failureThreshold: 60
            httpGet:
              path: /healthz/ready
              port: 15021
            periodSeconds: 1
            successThreshold: 1
            timeoutSeconds: 2
          {{- /*  Note: this is not *all* ports, since those will be dynamically set. However, this is the static port which is useful for setting up monitoring */}}
          ports:
          - containerPort: 15020
            name: metrics
            protocol: TCP
          {{- with $gateway.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          args:
            - -f
            - /config/config.yaml
          env:
          {{- /* Build a set of user-specified env var names for deduplication */}}
          {{- $userEnvNames := dict }}
          {{- range $gateway.env }}
            {{- $_ := set $userEnvNames .name true }}
          {{- end }}
          {{- /* Template-based defaults (skip if user overrides) */}}
            {{- if not (hasKey $userEnvNames "TERMINATION_GRACE_PERIOD_SECONDS") }}
            - name: TERMINATION_GRACE_PERIOD_SECONDS
              value: "{{($gateway.shutdown).max|default 60}}"
            {{- end }}
            {{- if not (hasKey $userEnvNames "CONNECTION_MIN_TERMINATION_DEADLINE") }}
            - name: CONNECTION_MIN_TERMINATION_DEADLINE
              value: "{{ ($gateway.shutdown).min | default 10 }}s"
            {{- end }}
            {{- if not (hasKey $userEnvNames "NODE_NAME") }}
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            {{- end }}
            {{- if not (hasKey $userEnvNames "POD_NAMESPACE") }}
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            {{- end }}
            {{- if not (hasKey $userEnvNames "POD_NAME") }}
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            {{- end }}
            {{- if not (hasKey $userEnvNames "RUST_BACKTRACE") }}
            - name: RUST_BACKTRACE
              value: "1"
            {{- end }}
            {{- if not (hasKey $userEnvNames "RUST_LOG") }}
            - name: RUST_LOG
              value: {{ ($gateway.logging).level | default "info" | quote }}
            {{- end }}
            - name: XDS_ADDRESS
              {{- if and $gateway.xds.tls $gateway.xds.tls.enabled }}
              value: "https://{{ $gateway.xds.host }}:{{ $gateway.xds.port }}"
              {{- else }}
              value: "http://{{ $gateway.xds.host }}:{{ $gateway.xds.port }}"
              {{- end }}
            {{- if and $gateway.xds.tls $gateway.xds.tls.enabled }}
            - name: XDS_ROOT_CA
              value: "/etc/xds-tls/ca.crt"
            {{- end }}
            {{- if not (hasKey $userEnvNames "NAMESPACE") }}
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            {{- end }}
            {{- if not (hasKey $userEnvNames "GATEWAY") }}
            - name: GATEWAY
              value: {{ include "kgateway.gateway.fullname" . }}
            {{- end }}
            {{- if not (hasKey $userEnvNames "CPU_LIMIT") }}
            - name: CPU_LIMIT
              valueFrom:
                resourceFieldRef:
                  resource: limits.cpu
                  divisor: "1"
            {{- end }}
            {{- if not (hasKey $userEnvNames "INSTANCE_IP") }}
            - name: INSTANCE_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            {{- end }}
            {{- if not (hasKey $userEnvNames "SERVICE_ACCOUNT") }}
            - name: SERVICE_ACCOUNT
              valueFrom:
                fieldRef:
                  fieldPath: spec.serviceAccountName
            {{- end }}
            {{- if and (not (hasKey $userEnvNames "CA_ADDRESS")) (hasKey $gateway "istio") }}
            - name: CA_ADDRESS
              value: {{ $gateway.istio.caAddress | default "https://istiod.istio-system.svc:15012" | quote }}
            {{- end }}
            {{- if and (not (hasKey $userEnvNames "TRUST_DOMAIN")) (hasKey $gateway "istio") }}
            - name: TRUST_DOMAIN
              value: {{ $gateway.istio.trustDomain | default "cluster.local" | quote }}
            {{- end }}
          {{- /* User-specified env vars */}}
          {{- with $gateway.env }}
            {{- toYaml . | nindent 12 }}
          {{- end }}
          volumeMounts:
            - name: config-volume
              mountPath: /config
            # Make /tmp writeable, needed for pprof
            - name: tmp
              mountPath: /tmp
            - name: xds-token
              mountPath: /var/run/secrets/xds-tokens
              readOnly: true
            {{- if and $gateway.xds.tls $gateway.xds.tls.enabled }}
            - name: xds-ca
              mountPath: /etc/xds-tls
              readOnly: true
            {{- end }}
            {{- if hasKey $gateway "istio" }}
            - mountPath: /var/run/secrets/istio
              name: istiod-ca-cert
            - mountPath: /var/run/secrets/tokens
              name: istio-token
            {{- end }}
      volumes:
        - name: config-volume
          configMap:
            name: {{ include "kgateway.gateway.fullname" . }}
        - name: xds-token
          projected:
            sources:
            - serviceAccountToken:
                audience: kgateway
                expirationSeconds: 43200
                path: xds-token
        - name: tmp
          emptyDir: {}
        {{- if and $gateway.xds.tls $gateway.xds.tls.enabled }}
        - name: xds-ca
          configMap:
            name: {{ include "kgateway.gateway.fullname" . }}-xds-ca
            items:
            - key: ca.crt
              path: ca.crt
        {{- end }}
        {{- if hasKey $gateway "istio" }}
        - configMap:
            name: istio-ca-root-cert
          name: istiod-ca-cert
        - name: istio-token
          projected:
            sources:
              - serviceAccountToken:
                  audience: istio-ca
                  expirationSeconds: 43200
                  path: istio-token
        {{- end }}
      terminationGracePeriodSeconds: {{($gateway.shutdown).max|default 60|int}}
