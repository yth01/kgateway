# This test validates cross-namespace JWT provider configuration
# with ReferenceGrant enforcement. It includes:
#
# 1. Two HTTPRoutes: "cross-namespace-allowed" and "cross-namespace-denied"
# 2. Two TrafficPolicies "allowed-policy" and "denied-policy" that reference JWT GatewayExtensions
# 3. A remote JWKS Service "remote-jwks" in the "remote" namespace
# 4. Two GatewayExtensions with JWT providers that reference the remote Service:
#    - "allowed-jwt-ext": Has a ReferenceGrant allowing cross-namespace access (should succeed)
#    - "denied-jwt-ext" in the "denied" namespace: Missing a ReferenceGrant (should not apply policy)
#
# The test verifies that cross-namespace Service references in JWT provider
# backendRefs require a ReferenceGrant, and that the translator correctly handles
# both allowed and denied cases.
---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: example-gateway
spec:
  gatewayClassName: example-gateway-class
  allowedRoutes:
    namespaces:
      from: All
  listeners:
    - name: http
      protocol: HTTP
      port: 80
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: cross-namespace-allowed
spec:
  parentRefs:
    - name: example-gateway
  hostnames:
    - "allowed.example.com"
  rules:
    - backendRefs:
        - name: backend-svc
          port: 80
      matches:
        - path:
            type: PathPrefix
            value: /allowed
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: cross-namespace-denied
spec:
  parentRefs:
    - name: example-gateway
  hostnames:
    - "denied.example.com"
  rules:
    - backendRefs:
        - name: backend-svc
          port: 80
      matches:
        - path:
            type: PathPrefix
            value: /denied
---
apiVersion: v1
kind: Service
metadata:
  name: backend-svc
spec:
  selector:
    app: backend-svc
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: remote-jwks
spec:
  ports:
    - protocol: TCP
      port: 8080
      targetPort: 8080
---
apiVersion: gateway.kgateway.dev/v1alpha1
kind: TrafficPolicy
metadata:
  name: allowed-policy
spec:
  targetRefs:
    - kind: HTTPRoute
      group: gateway.networking.k8s.io
      name: cross-namespace-allowed
  jwtAuth:
    extensionRef:
      name: allowed-jwt-ext
---
apiVersion: gateway.kgateway.dev/v1alpha1
kind: TrafficPolicy
metadata:
  name: denied-policy
spec:
  targetRefs:
    - kind: HTTPRoute
      group: gateway.networking.k8s.io
      name: cross-namespace-denied
  jwtAuth:
    extensionRef:
      name: denied-jwt-ext
      namespace: denied
---
apiVersion: v1
kind: Service
metadata:
  name: remote-jwks
  namespace: remote
spec:
  selector:
    app: allowed-remote-jwks
  ports:
    - protocol: TCP
      port: 8080
      targetPort: 8080
---
# Allow GatewayExtensions in the "default" namespace to reference the remote JWKS Service in the "remote" namespace
apiVersion: gateway.networking.k8s.io/v1beta1
kind: ReferenceGrant
metadata:
  name: allow-gwext-to-remote-jwks
  namespace: remote
spec:
  from:
    - group: gateway.kgateway.dev
      kind: GatewayExtension
      namespace: default
  to:
    - group: ""
      kind: Service
      name: remote-jwks
---
apiVersion: gateway.kgateway.dev/v1alpha1
kind: GatewayExtension
metadata:
  name: allowed-jwt-ext
spec:
  jwt:
    providers:
    - name: allowed-provider
      claimsToHeaders:
        - name: org
          header: x-org
      issuer: https://allowed.example.com
      jwks:
        remote:
          url: https://allowed.example.com/jwks
          cacheDuration: 2m
          backendRef:
            group: ""
            kind: Service
            name: remote-jwks
            namespace: remote
            port: 8080
---
# has to be in another namespace because the ReferenceGrant allow-gwext-to-remote-jwks
# applies to all GatewayExtensions in the "default" namespace,
# i.e. RefGrants are not scoped to a specific GatewayExtension.
apiVersion: gateway.kgateway.dev/v1alpha1
kind: GatewayExtension
metadata:
  name: denied-jwt-ext
  namespace: denied
spec:
  jwt:
    providers:
    - name: denied-provider
      claimsToHeaders:
        - name: team
          header: x-team
      issuer: https://denied.example.com
      jwks:
        remote:
          url: https://denied.example.com/jwks
          cacheDuration: 2m
          backendRef:
            group: ""
            kind: Service
            name: remote-jwks
            namespace: remote
            port: 8080