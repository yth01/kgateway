name: Lint

on:
  pull_request: { }
  merge_group:
    types: [checks_requested]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  # Lint Go code with golangci-lint
  go-lint:
    name: Go
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    steps:
    - name: Check out code into the Go module directory
      uses: actions/checkout@v4
    - name: Prep Go Runner
      uses: ./.github/actions/prep-go-runner
    - name: Lint Go code
      run: make analyze

  # Lint Helm charts
  helm-lint:
    name: Helm
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    steps:
    - name: Check out code into the Go module directory
      uses: actions/checkout@v4
    - name: Lint Helm Charts
      run: make lint-kgateway-charts

  # Lint GitHub workflow files
  action-lint:
    name: GHA
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    steps:
    - uses: actions/checkout@v4
      with:
        sparse-checkout: .github
    - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
      with:
        go-version-file: 'go.mod'
    - run: make lint-actions

  # Lint Rust code
  rust-lint:
    name: Rust
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Install Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: 1.86.0
        components: clippy,rustfmt
        cache: true
    - name: Lint
      run: |
        make -C internal/envoyinit lint
