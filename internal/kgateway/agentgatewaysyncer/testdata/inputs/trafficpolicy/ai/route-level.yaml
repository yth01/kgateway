apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: example-gateway
  namespace: default
spec:
  gatewayClassName: agentgateway
  listeners:
  - allowedRoutes:
      namespaces:
        from: Same
    name: http
    port: 8080
    protocol: HTTP
---
apiVersion: gateway.kgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  labels:
    app: kgateway
  name: openai
spec:
  ai:
    provider:
      openai:
        model: "gpt-4o-mini"
---
apiVersion: v1
kind: Secret
metadata:
  name: openai-secret
type: Opaque
data:
  Authorization: bXlzZWNyZXRrZXk=
---
apiVersion: gateway.kgateway.dev/v1alpha1
kind: AgentgatewayPolicy
metadata:
  name: ai-policy
  namespace: default
spec:
  backend:
    ai:
      prompt:
        prepend:
        - content: "You are a helpful assistant. Always be polite and professional."
          role: system
        - content: "Remember to follow company guidelines."
          role: system
        append:
        - content: "Please provide a concise response."
          role: user
      promptGuard:
        request:
        - response:
            message: "Your request was rejected due to inappropriate content"
            statusCode: 403
          webhook:
            backendRef:
              name: webhook
              port: 80
            forwardHeaderMatches:
            - type: Exact
              name: x-foo
              value: bar
            - type: RegularExpression
              name: x-baz
              value: ^baz-.*
        - regex:
            action: REJECT
            matches:
            - (?i)(hate|kill|harm)
            - (?i)(bad|words)
            builtins:
              - CREDIT_CARD
              - SSN
        - openAIModeration:
            model: text-moderation-latest
            policies:
              auth:
                secretRef:
                  name: openai-secret
        response:
        - webhook:
            backendRef:
              name: webhook
              port: 80
        - regex:
            action: MASK
            builtins:
            - EMAIL
            - PHONE_NUMBER
            matches:
            - \b\d{4}\b
            - (?i)(password|secret)
      defaults:
        - field: top_p
          value: 0.95
        - field: frequency_penalty
          value: 0.1
        - field: presence_penalty
          value: 0.1
        - field: string
          value: "some_string"
        - field: array_int
          value: [1,2,3]
        - field: array_string
          value: ["one","two","three"]
      overrides:
      - field: max_tokens
        value: 2000
      - field: temperature
        value: 0.5
      modelAliases:
        fast: "gpt-3.5-turbo"
        smart: "gpt-4-turbo"
        default: "gpt-4o-mini"
  targetRefs:
  - group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: openai-test
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: openai-test
  namespace: default
spec:
  parentRefs:
  - group: gateway.networking.k8s.io
    kind: Gateway
    name: example-gateway
  rules:
  - backendRefs:
    - group: gateway.kgateway.dev
      kind: AgentgatewayBackend
      name: openai
      weight: 1
    matches:
    - path:
        type: PathPrefix
        value: /v1/chat/completions
---
apiVersion: v1
kind: Service
metadata:
  name: webhook
  namespace: default
spec:
  ports:
  - port: 80